x-runner-env: &runner-env
  GH_OWNER: ${GH_OWNER}
  GH_REPO: ${GH_REPO}
  GH_PAT: ${GH_PAT}
  RUNNER_GROUP: ${RUNNER_GROUP}
  RUNNER_LABELS: ${RUNNER_LABELS}

x-runner-vols: &runner-vols
  - //var/run/docker.sock:/var/run/docker.sock
  - ./register-and-run.sh:/home/runner/register-and-run.sh:ro
  - runner-cache:/_work
  - pub-cache:/home/runner/.pub-cache
  - npm-cache:/home/runner/.npm
  - pnpm-store:/home/runner/.local/share/pnpm
  - flutter-cache:/home/runner/.cache/flutter
  - claude-code:/opt/claude-code

x-runner-svc: &runner-svc
  # Use pre-built image from GitHub Container Registry
  # To build locally instead, comment out 'image' and uncomment 'build'
  # Note: GHCR_OWNER must be lowercase (Docker requirement)
  image: ghcr.io/${GHCR_OWNER:-pfilbin90}/actions-runner-flutter:latest
  # build:
  #   context: .
  #   dockerfile: Dockerfile.runner
  environment: *runner-env
  volumes: *runner-vols
  entrypoint: ["/bin/bash","-lc","/home/runner/register-and-run.sh"]
  restart: always
  # Cap each runner so one container can't starve the others.
  # Budget: Gradle JVM ~2.8GB + emulator 1.5GB + Flutter/OS ~1.5GB â‰ˆ 6GB
  # 12GB limit gives headroom for spikes without letting a single runner
  # consume all host RAM when 4 containers run integration tests concurrently.
  mem_limit: 12g
  memswap_limit: 14g
  # Explicit DNS servers to prevent resolution failures under load
  # Docker's internal DNS proxy can fail during heavy Gradle builds
  dns:
    - 8.8.8.8
    - 8.8.4.4
    - 1.1.1.1

# KVM device for Linux hosts (enables hardware-accelerated Android emulator)
x-kvm-device: &kvm-device
  devices:
    - /dev/kvm:/dev/kvm

services:
  runner-1:
    <<: [*runner-svc, *kvm-device]
    environment:
      <<: *runner-env
      RUNNER_NAME: ${RUNNER_NAME_PREFIX}-1
  runner-2:
    <<: [*runner-svc, *kvm-device]
    environment:
      <<: *runner-env
      RUNNER_NAME: ${RUNNER_NAME_PREFIX}-2
  runner-3:
    <<: [*runner-svc, *kvm-device]
    environment:
      <<: *runner-env
      RUNNER_NAME: ${RUNNER_NAME_PREFIX}-3
  runner-4:
    <<: [*runner-svc, *kvm-device]
    environment:
      <<: *runner-env
      RUNNER_NAME: ${RUNNER_NAME_PREFIX}-4

volumes:
  runner-cache:
  pub-cache:
  npm-cache:
  pnpm-store:
  flutter-cache:
  claude-code:

networks:
  default:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: "1500"

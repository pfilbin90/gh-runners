name: Rebuild Runner Image

on:
  schedule:
    # Run at 00:00 UTC on the 1st of every month
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      flutter_version:
        description: 'Flutter version to install (leave empty for default in Dockerfile)'
        required: false
        default: ''
      force_rebuild:
        description: 'Force rebuild even if no changes detected'
        required: false
        default: 'true'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/actions-runner-flutter

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Flutter version from Dockerfile
        id: flutter
        run: |
          # Get Flutter version from Dockerfile or use input
          if [ -n "${{ github.event.inputs.flutter_version }}" ]; then
            FLUTTER_VER="${{ github.event.inputs.flutter_version }}"
          else
            FLUTTER_VER=$(grep -E '^ENV FLUTTER_VERSION=' Dockerfile.runner | cut -d'=' -f2)
          fi
          echo "version=${FLUTTER_VER}" >> "$GITHUB_OUTPUT"
          echo "Flutter version: ${FLUTTER_VER}"

      - name: Generate build metadata
        id: meta
        run: |
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          SHORT_DATE=$(date -u +'%Y%m%d')
          FLUTTER_VER="${{ steps.flutter.outputs.version }}"

          echo "build_date=${BUILD_DATE}" >> "$GITHUB_OUTPUT"
          echo "short_date=${SHORT_DATE}" >> "$GITHUB_OUTPUT"

          # Generate tags
          TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:flutter-${FLUTTER_VER}"
          TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SHORT_DATE}"
          echo "tags=${TAGS}" >> "$GITHUB_OUTPUT"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.runner
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.build_date }}
            FLUTTER_VER=${{ steps.flutter.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Build for amd64 only (self-hosted runner is x64)
          platforms: linux/amd64

      - name: Generate image digest
        id: digest
        run: |
          echo "Image pushed with tags:"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:flutter-${{ steps.flutter.outputs.version }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.short_date }}"

      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Skip if Slack webhook URL is not configured
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping Slack notification"
            exit 0
          fi

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          FLUTTER_VER="${{ steps.flutter.outputs.version }}"
          BUILD_DATE="${{ steps.meta.outputs.short_date }}"

          if [ "${{ job.status }}" == "success" ]; then
            EMOJI=":white_check_mark:"
            STATUS="succeeded"
            COLOR="good"
            ACTION_TEXT="Run \`docker compose pull && docker compose up -d\` on your host machine to update your runners."
          else
            EMOJI=":x:"
            STATUS="failed"
            COLOR="danger"
            ACTION_TEXT="Check the workflow logs for details."
          fi

          SLACK_MESSAGE=$(cat <<EOF
          {
            "attachments": [
              {
                "color": "${COLOR}",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "${EMOJI} Runner Image Rebuild ${STATUS}"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Flutter Version:*\n\`${FLUTTER_VER}\`"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Build Date:*\n\`${BUILD_DATE}\`"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Image Tags:*\nâ€¢ \`ghcr.io/${{ env.IMAGE_NAME }}:latest\`\nâ€¢ \`ghcr.io/${{ env.IMAGE_NAME }}:flutter-${FLUTTER_VER}\`\nâ€¢ \`ghcr.io/${{ env.IMAGE_NAME }}:${BUILD_DATE}\`"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Action Required:*\n${ACTION_TEXT}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow Run"
                        },
                        "url": "${RUN_URL}"
                      }
                    ]
                  }
                ]
              }
            ]
          }
          EOF
          )

          curl -X POST "${SLACK_WEBHOOK_URL}" \
            -H 'Content-type: application/json' \
            --data "${SLACK_MESSAGE}" || echo "Failed to send Slack notification"

  create-update-reminder:
    needs: build-and-push
    if: success()
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Create GitHub Issue reminder
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”„ Runner Image Updated - Action Required';
            const flutterVersion = '${{ needs.build-and-push.outputs.flutter_version || 'latest' }}';
            const buildDate = new Date().toISOString().split('T')[0];

            const body = `## Monthly Runner Image Rebuild Complete

            A new version of the GitHub Actions runner image has been built and pushed to GHCR.

            ### Image Details
            - **Registry:** \`ghcr.io/${{ github.repository_owner }}/actions-runner-flutter\`
            - **Tags:** \`latest\`, \`flutter-${flutterVersion}\`, \`${buildDate.replace(/-/g, '')}\`
            - **Build Date:** ${buildDate}

            ### Action Required

            Run the following commands on your host machine to update your runners:

            \`\`\`powershell
            cd C:\\repos\\gh-runners
            docker compose pull
            docker compose down
            docker compose up -d
            \`\`\`

            Or use the update script:
            \`\`\`powershell
            cd C:\\repos\\gh-runners
            .\\update-runners.ps1
            \`\`\`

            ### Verification

            After updating, verify your runners are healthy:
            \`\`\`powershell
            docker compose ps
            docker compose logs --tail=20
            \`\`\`

            ---
            *This issue was automatically created by the monthly image rebuild workflow.*
            *Close this issue once you've updated your runners.*
            `;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'runner-update',
              per_page: 1
            });

            if (issues.data.length > 0) {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## New build available (${buildDate})\n\nA new image has been pushed. Please update your runners.`
              });
              console.log(`Commented on existing issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['runner-update', 'action-required']
              });
              console.log('Created new update reminder issue');
            }

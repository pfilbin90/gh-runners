# Extend the official runner (latest version)
FROM ghcr.io/actions/actions-runner:latest

USER root
SHELL ["/bin/bash", "-lc"]

# =============================================================================
# Base tools + Java 8 & 21 (both needed for Android SDK tooling)
# =============================================================================
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    curl wget git unzip xz-utils jq ca-certificates gnupg build-essential \
    python3 python3-pip sudo \
    openjdk-8-jdk openjdk-21-jdk \
    lcov \
  && rm -rf /var/lib/apt/lists/*

# Java environment variables for workflow compatibility
# Workflows can switch between Java versions using these env vars
ENV JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
ENV JAVA_HOME_8_X64=/usr/lib/jvm/java-8-openjdk-amd64
ENV JAVA_HOME_17_X64=/usr/lib/jvm/java-21-openjdk-amd64
ENV JAVA_HOME_21_X64=/usr/lib/jvm/java-21-openjdk-amd64

# =============================================================================
# Docker CLI + buildx + compose (no daemon - uses host's Docker socket)
# =============================================================================
RUN install -m 0755 -d /etc/apt/keyrings \
  && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
  && chmod a+r /etc/apt/keyrings/docker.gpg \
  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" > /etc/apt/sources.list.d/docker.list \
  && apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
      docker-ce-cli docker-buildx-plugin docker-compose-plugin \
  && rm -rf /var/lib/apt/lists/*

# Allow the runner user to call docker if you run as non-root
RUN groupadd -f docker && usermod -aG docker runner || true

# =============================================================================
# KVM support (for hardware-accelerated Android emulator)
# =============================================================================
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils \
    libc6-dev libstdc++6 lib32z1 lib32stdc++6 \
  && rm -rf /var/lib/apt/lists/* \
  && groupadd -f kvm && usermod -aG kvm runner || true \
  && chmod 666 /dev/kvm || true

# Note: /dev/kvm must be mounted from host at runtime for KVM to work
# Add to docker-compose.yml: devices: - /dev/kvm:/dev/kvm

# =============================================================================
# Node.js 22 + pnpm + firebase-tools
# =============================================================================
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
  && apt-get update && apt-get install -y nodejs \
  && npm i -g pnpm@9 firebase-tools \
  && rm -rf /var/lib/apt/lists/*

# =============================================================================
# Bun (required by claude-code-action)
# =============================================================================
RUN curl -fsSL https://bun.sh/install | bash \
  && ln -s /root/.bun/bin/bun /usr/local/bin/bun \
  && bun --version

# =============================================================================
# Google Chrome (stable) + ChromeDriver (auto-matched version)
# =============================================================================
RUN wget -qO- https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg \
  && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list \
  && apt-get update && apt-get install -y google-chrome-stable \
  && CHROMEDRIVER_URL="$(curl -fsSL https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json \
       | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform=="linux64") | .url')" \
  && curl -fsSL "$CHROMEDRIVER_URL" -o /tmp/chromedriver.zip \
  && unzip -o /tmp/chromedriver.zip -d /opt \
  && mv /opt/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver \
  && chmod +x /usr/local/bin/chromedriver \
  && rm -rf /tmp/chromedriver.zip /opt/chromedriver-linux64 /var/lib/apt/lists/*

# =============================================================================
# Android SDK (command-line tools, platform-tools, build-tools, emulator)
# =============================================================================
ENV ANDROID_HOME=/opt/android-sdk
ENV ANDROID_SDK_ROOT=/opt/android-sdk
ENV PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH

RUN mkdir -p $ANDROID_HOME/cmdline-tools \
  && curl -fsSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o /tmp/cmdline-tools.zip \
  && unzip -q /tmp/cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools \
  && mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest \
  && rm /tmp/cmdline-tools.zip \
  # Accept all licenses
  && yes | sdkmanager --licenses \
  # Install SDK components including system image for integration tests
  # Flutter 3.38+ targets API 35, so we need SDK 35 pre-installed
  && sdkmanager \
      "platform-tools" \
      "platforms;android-33" \
      "platforms;android-34" \
      "platforms;android-35" \
      "build-tools;34.0.0" \
      "build-tools;35.0.0" \
      "emulator" \
      "system-images;android-33;google_apis;x86_64" \
  && rm -rf /tmp/*

# Pre-create the AVD so integration tests don't have to
# New Android SDK cmdline-tools require Java 17+ (class file version 61.0)
RUN export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64 \
  && export PATH="$JAVA_HOME/bin:$PATH" \
  && echo "no" | avdmanager create avd \
      --name "test_avd" \
      --package "system-images;android-33;google_apis;x86_64" \
      --device "pixel_4" \
      --force \
  && echo "AVD created successfully"

ARG FLUTTER_CACHE_BUST=1
# =============================================================================
# Flutter SDK (automatically fetches latest stable version)
# Rebuilding the image will pick up the newest stable Flutter release
# =============================================================================
ENV FLUTTER_HOME=/opt/flutter
ENV PATH=$FLUTTER_HOME/bin:$FLUTTER_HOME/bin/cache/dart-sdk/bin:$PATH

RUN FLUTTER_VERSION=$(curl -fsSL https://storage.googleapis.com/flutter_infra_release/releases/releases_linux.json \
      | jq -r '[.releases[] | select(.channel == "stable")][0].version') \
  && test -n "$FLUTTER_VERSION" || { echo "ERROR: Failed to fetch Flutter version"; exit 1; } \
  && echo "Installing Flutter $FLUTTER_VERSION" \
  && git clone --depth 1 -b $FLUTTER_VERSION https://github.com/flutter/flutter.git $FLUTTER_HOME \
  && git config --global --add safe.directory $FLUTTER_HOME \
  && flutter --version \
  && flutter precache --linux --web --android \
  # Accept Android licenses for Flutter
  && flutter doctor --android-licenses || true \
  && flutter doctor

# =============================================================================
# Supabase CLI (for local Supabase development/testing)
# =============================================================================
RUN curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz \
  | tar -xz -C /usr/local/bin supabase \
  && supabase --version

# =============================================================================
# GitHub CLI (gh) for GitHub API interactions
# =============================================================================
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
      | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
  && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
      > /etc/apt/sources.list.d/github-cli.list \
  && apt-get update && apt-get install -y gh \
  && rm -rf /var/lib/apt/lists/* \
  && gh --version

# =============================================================================
# Final setup
# =============================================================================
RUN usermod -aG sudo runner || true

# Keep runner working dir consistent with your compose mounts
WORKDIR /home/runner/actions-runner

# (We do NOT override ENTRYPOINT/CMD; register-and-run.sh handles config/run)

# =============================================================================
# Version labels for tracking
# =============================================================================
ARG BUILD_DATE
LABEL org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.title="actions-runner-flutter" \
      org.opencontainers.image.description="Self-hosted GitHub Actions runner with Flutter, Android SDK, and CI tools" \
      flutter.version="latest-stable"
